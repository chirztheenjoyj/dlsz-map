<html>
<head>
  <meta charset="utf-8" />
  <title>DLSZ Interactive Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    #map { height: 100vh; }

    .directions {
      position: absolute;
      background: rgba(255, 240, 240, 0.9);
      padding: 12px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      color: darkred;
      z-index: 1000;
      max-width: 220px;
    }

    #toggle-box {
      top: 10px;
      right: 10px;
      left: auto;
    }

    /* === Modal Styles === */
    #infoModal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      text-align: center;
      padding: 20px;
    }
    #infoModal img {
      max-width: 90%;
      max-height: 70%;
      border-radius: 12px;
    }
    #infoModal h2 { margin: 15px 0 10px; }
    #infoModal p { max-width: 80%; margin: 0 auto; }
    #closeModal {
      position: absolute;
      top: 20px; right: 30px;
      font-size: 32px;
      cursor: pointer;
    }
    .gallery-controls {
      margin-top: 12px;
    }
    .gallery-controls button {
      padding: 8px 16px;
      margin: 0 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- üìç Direction panel -->
<div id="directions-panel" class="directions" style="display:none; top: 60px; left: 10px;">
  <h4>Directions</h4>
  <ol id="steps"></ol>
</div>

<!-- üß≠ Dropdown toggle -->
<div id="toggle-box" class="directions">
  <label for="mode-select">Mode:</label>
  <select id="mode-select">
    <option value="directions" selected>Show Directions</option>
    <option value="info">Show Information</option>
  </select>
</div>

<!-- üñºÔ∏è Modal for Information -->
<div id="infoModal">
  <span id="closeModal">&times;</span>
  <img id="modalImg" src="" />
  <h2 id="modalTitle"></h2>
  <p id="modalInfo"></p>
  <div class="gallery-controls">
    <button id="prevImg">‚óÄ Prev</button>
    <button id="nextImg">Next ‚ñ∂</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
const map = L.map('map').setView([14.4093, 121.0195], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const userIcon = L.divIcon({
  html: 'üö∂‚Äç‚ôÇÔ∏è',
  className: '',
  iconSize: [24, 24],
  iconAnchor: [12, 12]
});
const userMarker = L.marker([0, 0], { icon: userIcon }).addTo(map);

map.locate({ setView: true, maxZoom: 19, watch: true });
map.on('locationfound', function (e) {
  userMarker.setLatLng(e.latlng);
});

const buildings = [
  { name: "Sports Pavilion", coords: [14.4102708, 121.0194265], info: "Modern sports venue" },
  { name: "DLSZ Football Field", coords: [14.4104647, 121.0201077], info: "FIFA-certified turf field" },
  { name: "Mutien Marie Building", coords: [14.4097899, 121.0204980], info: "Admin and registrar" },
  { name: "La Salle Building", coords: [14.4093200, 121.0201930], info: "Classrooms and offices" },
  { name: "Cadlum Hall & St. Leo Flavius Hall", coords: [14.4096818, 121.0193090], info: "Lecture halls" },
  { name: "Angelo King CPA", coords: [14.4096396, 121.0196036], info: "Performing arts center" },
  { name: "Br. Ceci Hojilla FSC or CLF", coords: [14.4087662, 121.0209836], info: "Lasallian formation hub" },
  { name: "Our Lady of the Star Chapel", coords: [14.4086150, 121.0206765], info: "Worship area" },
  { name: "St. Joseph Building", coords: [14.410289252625368, 121.01894337355556], info: "STEM and IT facilities", img: "https://i.ibb.co/xS8W4t7m/IMG-20250812-145144.jpg" },
  { name: "Gym 3", coords: [14.410508, 121.018902], info: "Multi-use gym" },
  { name: "School Fountain", coords: [14.409468, 121.019594], info: "Central campus landmark" },
  { name: "Debbie Decena Auditorium", coords: [14.409014, 121.020375], info: "Auditorium for events" }
];

/* === Galleries: images + description === */
const buildingGalleries = {
  "School Fountain": [
    {
      src: "https://i.ibb.co/7hRwrFs/IMG-20250812-145646.jpg",
      desc: "The iconic fountain at the heart of campus, often used as a landmark and meeting place."
    },
    {
      src: "https://i.ibb.co/4RvKCLMX/IMG-20250812-145633.jpg",
      desc: "Another view of the school fountain, showing the surrounding greenery and open space."
    }
  ],
  "Sports Pavilion": [
    {
      src: "https://ibb.co/CpRkYbC4",
      desc: "Modern sports venue equipped for basketball, futsal, judo, and more."
    },
    {
      src: "https://ibb.co/3gM1N73",
      desc: "place holder."
},
{
      src: "https://ibb.co/YBN1Q14P",
      desc: "placeholder."
    },
    {
      src: "https://ibb.co/5WPP4jCD",
      desc: "place holder."
}
],
  "Angelo King CPA": [
    {
      src: "https://i.ibb.co/TDzP6dVs/IMG-20250812-145543.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/KcCVdSMJ/IMG-20250812-145543.jpg",
      desc: "Placeholder."
    }
  ],
  "Cadlum Hall & St. Leo Flavius Hall": [
  {
    src: "https://i.ibb.co/7JKWkRGK/IMG-20250812-145529.jpg",
    desc: "Placeholder."
  },
  {
    src: "https://i.ibb.co/Kxp9Y2s5/IMG-20250812-145411.jpg",
    desc: "place holder."
  },
  {
    src: "https://i.ibb.co/s0LrrzR/IMG-20250812-145343.jpg",
    desc: "placeholder."
  },
  {
    src: "https://i.ibb.co/84M77XH5/IMG-20250812-145302.jpg",
    desc: "place holder."
  },
  {
    src: "https://i.ibb.co/Z60FfPXt/IMG-20250812-145352.jpg",
    desc: "placeholder."
  }
],
"DLSZ Football Field": [
  {
    src: "https://i.ibb.co/bj2smjwQ/IMG-20250812-144752.jpg",
    desc: "Placeholder."
  },
  {
    src: "https://i.ibb.co/8g42CmZ9/IMG-20250812-144741.jpg",
    desc: "place holder."
  },
  {
    src: "https://i.ibb.co/67xPD9LN/IMG-20250812-144616.jpg",
    desc: "placeholder."
  },
  {
    src: "https://i.ibb.co/fdVvqTJ7/IMG-20250812-144553.jpg",
    desc: "Placeholder."
  }
],
  "St. Joseph Building": [
    {
      src: "https://i.ibb.co/bjd1yzCn/IMG-20250812-145219.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/DHzMmCxx/IMG-20250812-145151.jpg",
      desc: "place holder."
},
{
      src: "https://i.ibb.co/xS8W4t7m/IMG-20250812-145144.jhttpspg",
      desc: "placeholder."
}
],
  "Mutien Marie Building": [
    {
      src: "https://i.ibb.co/99wq1943/IMG-20250812-144302.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/JwhM0scK/IMG-20250812-144457.jpg",
      desc: "place holder."
}
],
  "La Salle Building": [
    {
      src: "https://i.ibb.co/99wq1943/IMG-20250812-144302.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/JwhM0scK/IMG-20250812-144457.jpg",
      desc: "place holder."
}
],
  "Br. Ceci Hojilla FSC or CLF": [
    {
      src: "https://i.ibb.co/4ZPJCbGp/IMG-20250812-143911.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/jvzr9cKS/IMG-20250812-143953.jpg",
      desc: "place holder."
}
],
  "La Salle Building": [
    {
      src: "https://i.ibb.co/KpD4RNfq/IMG-20250812-143857.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/BVtn2J9d/IMG-20250812-144219.jpg",
      desc: "place holder."
}
],
  "Debbie Decena Auditorium": [
    {
      src: "https://i.ibb.co/1J8TtmrG/IMG-20250812-143555.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/GLJ5HnF/IMG-20250812-143610.jpg",
      desc: "place holder."
    },
    {
      src: "https://i.ibb.co/cc5zXjmV/IMG-20250812-143627.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/zVqXNkKn/IMG-20250812-143658.jpg",
      desc: "place holder."
    },
    {
      src: "https://i.ibb.co/ymS1WsBF/IMG-20250812-143709.jpg",
      desc: "Placeholder."
    },
    {
      src: "https://i.ibb.co/Y7sRgM9b/IMG-20250812-143719.jpg",
      desc: "place holder."
    },
    {
      src: "https://i.ibb.co/rKnn5tp7/IMG-20250812-143730.jpg",
      desc: "Placeholder."
    },
],
};

const nodeMap = {}, adjacencyList = {};
let start = null, end = null, routeLayer = null;

/* === Marker setup === */
buildings.forEach(b => {
  nodeMap[b.name] = b.coords;
  adjacencyList[b.name] = [];

  const marker = L.marker(b.coords).addTo(map);

  marker.on('click', () => {
    const mode = document.getElementById('mode-select').value;

    if (mode === 'info') {
      // üîπ Open big modal gallery
      openInfoModal(b.name, b.info);
    } else {
      // üîπ Small popup for directions mode
      marker.bindPopup(`<b>${b.name}</b><br>${b.info || ""}`).openPopup();

      // Directions start/end
      if (!start) {
        start = b.name;
        alert('üìç Start: ' + b.name);
      } else if (!end) {
        end = b.name;
        if (start === end) {
          alert('Pick different destination!');
          start = end = null;
          return;
        }
        computeRoute(start, end);
        start = end = null;
      }
    }
  });
});

/* === Modal logic === */
let currentGallery = [], galleryIndex = 0;

function openInfoModal(name, info) {
  const gallery = buildingGalleries[name] || [];
  currentGallery = gallery;
  galleryIndex = 0;

  document.getElementById('modalTitle').textContent = name;
  document.getElementById('modalInfo').textContent = (gallery[0]?.desc) || info || "";
  document.getElementById('modalImg').src = (gallery[0]?.src) || "";

  document.getElementById('infoModal').style.display = "flex";
}

document.getElementById('closeModal').onclick = () => {
  document.getElementById('infoModal').style.display = "none";
};

document.getElementById('prevImg').onclick = () => {
  if (currentGallery.length) {
    galleryIndex = (galleryIndex - 1 + currentGallery.length) % currentGallery.length;
    document.getElementById('modalImg').src = currentGallery[galleryIndex].src;
    document.getElementById('modalInfo').textContent = currentGallery[galleryIndex].desc;
  }
};

document.getElementById('nextImg').onclick = () => {
  if (currentGallery.length) {
    galleryIndex = (galleryIndex + 1) % currentGallery.length;
    document.getElementById('modalImg').src = currentGallery[galleryIndex].src;
    document.getElementById('modalInfo').textContent = currentGallery[galleryIndex].desc;
  }
};

/* === Graph + Routing === */
function addEdge(a, b) {
  const [la, lo] = nodeMap[a], [lb, lo2] = nodeMap[b];
  const dist = Math.hypot(la - lb, lo - lo2);
  adjacencyList[a].push({ node: b, dist });
  adjacencyList[b].push({ node: a, dist });
}

addEdge("Sports Pavilion", "Gym 3");
addEdge("Gym 3", "St. Joseph Building");
addEdge("Sports Pavilion", "Angelo King CPA");
addEdge("Angelo King CPA", "Cadlum Hall & St. Leo Flavius Hall");
addEdge("Cadlum Hall & St. Leo Flavius Hall", "School Fountain");
addEdge("School Fountain", "La Salle Building");
addEdge("La Salle Building", "Mutien Marie Building");
addEdge("Mutien Marie Building", "Br. Ceci Hojilla FSC or CLF");
addEdge("Br. Ceci Hojilla FSC or CLF", "Our Lady of the Star Chapel");
addEdge("La Salle Building", "DLSZ Football Field");
addEdge("Debbie Decena Auditorium", "Mutien Marie Building");
addEdge("Debbie Decena Auditorium", "La Salle Building");

function dijkstra(s, e) {
  const dist = {}, prev = {};
  Object.keys(adjacencyList).forEach(n => { dist[n] = 1e9; prev[n] = null; });
  dist[s] = 0;
  const Q = Object.keys(dist);
  while (Q.length) {
    Q.sort((a, b) => dist[a] - dist[b]);
    const u = Q.shift();
    if (u === e) break;
    adjacencyList[u].forEach(({ node: vn, dist: d2 }) => {
      if (dist[u] + d2 < dist[vn]) {
        dist[vn] = dist[u] + d2;
        prev[vn] = u;
      }
    });
  }
  const path = [];
  let u = e;
  while (u) { path.unshift(u); u = prev[u]; }
  return path;
}

function getDirection(prev, current, next) {
  const angle = (p1, p2) => Math.atan2(p2[1] - p1[1], p2[0] - p1[0]);
  const deg = x => x * (180 / Math.PI);
  const a1 = angle(prev, current);
  const a2 = angle(current, next);
  const delta = deg(a2 - a1);
  const normalized = ((delta + 360) % 360);
  if (normalized < 30 || normalized > 330) return "Go straight";
  if (normalized >= 30 && normalized <= 150) return "Turn right";
  if (normalized >= 210 && normalized <= 330) return "Turn left";
  return "Continue";
}

function computeRoute(a, b) {
  const p = dijkstra(a, b);
  if (routeLayer) map.removeLayer(routeLayer);
  const coords = p.map(n => nodeMap[n]);
  routeLayer = L.polyline(coords, { color: '#90ee90', weight: 5, dashArray: '5,5' }).addTo(map);
  map.fitBounds(routeLayer.getBounds());

  const panel = document.getElementById('directions-panel');
  const ol = document.getElementById('steps');
  ol.innerHTML = '';
  for (let i = 0; i < p.length; i++) {
    if (i === 0) ol.innerHTML += `<li>Start at ${p[i]}</li>`;
    else if (i === p.length - 1) ol.innerHTML += `<li>Arrive at ${p[i]}</li>`;
    else {
      const dir = getDirection(nodeMap[p[i - 1]], nodeMap[p[i]], nodeMap[p[i + 1]]);
      ol.innerHTML += `<li>${dir} to ${p[i + 1]}</li>`;
    }
  }
  panel.style.display = 'block';
}

document.getElementById('mode-select').addEventListener('change', (e) => {
  if (e.target.value === 'info') {
    document.getElementById('directions-panel').style.display = 'none';
    if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
    start = end = null;
  }
});
</script>
</body>
</html>
