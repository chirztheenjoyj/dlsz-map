<!doctype html>
<html>
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-823W7XK4TZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-823W7XK4TZ');
</script>
  <meta charset="utf-8" />
  <title>DLSZ Interactive Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --panel-w:320px;
      --gallery-h-desktop:180px;
      --gallery-h-mobile:140px;
      --base-gap:16px;
      --fab-size:56px;
    }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,Arial,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    #map{ height:100vh; width:100%; }

    /* Gallery FAB (bottom-left preview) */
    #galleryFab{
      position:fixed; left:16px; bottom:16px; width:140px; height:84px; border-radius:12px; overflow:hidden;
      z-index:1400; box-shadow:0 10px 30px rgba(0,0,0,0.14); background:#fff; cursor:pointer; border:1px solid rgba(0,0,0,0.06);
      transition: bottom 260ms cubic-bezier(.2,.9,.3,1), transform 200ms ease, opacity 240ms ease;
    }
    #galleryFab img{ position:absolute; width:100%; height:100%; object-fit:cover; left:0; top:0; opacity:0; transition:opacity .8s ease; }
    #galleryFab img.active{ opacity:1; }
    #galleryFab .caption{ position:absolute; bottom:6px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); color:#222; padding:4px 8px; border-radius:10px; font-size:12px; z-index:1410; }

    /* Key people FAB */
    #keyFab{ position:fixed; left:16px; bottom:140px; width:52px; height:52px; border-radius:10px; background:#1b5e20; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:1420; box-shadow:0 6px 18px rgba(0,0,0,0.12); transition: bottom 260ms cubic-bezier(.2,.9,.3,1); }

    /* Directions FAB */
    #guideFab{ position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:12px; background:#43a047; color:white; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:1420; box-shadow:0 6px 18px rgba(0,0,0,0.12); transition: bottom 260ms cubic-bezier(.2,.9,.3,1), right 260ms ease, top 260ms ease; }

    /* Leaflet zoom: default position */
    .leaflet-control-zoom { position: fixed !important; right:16px; bottom:86px; z-index:1420; transition: bottom 260ms cubic-bezier(.2,.9,.3,1), top 260ms ease, right 260ms ease; }

    /* Guide panel (directions) */
    #guide-panel{
      position:fixed; right:16px; bottom:16px; width:var(--panel-w); max-height:46vh;
      background:linear-gradient(180deg,#fff 0%, #fbfbfb 100%); padding:12px; box-shadow:-8px 0 28px rgba(0,0,0,0.12); border-radius:10px;
      z-index:1450; transform: translateY(120%); transition: transform 360ms cubic-bezier(.2,.9,.3,1), bottom 300ms ease, opacity 260ms ease;
      overflow:auto;
    }
    #guide-panel.active{ transform: translateY(0); opacity:1; }

    #guide-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    #guide-header h4{ margin:0; font-size:14px; color:#123; }
    #panelClose{ background:#efefef; color:#333; border-radius:8px; padding:6px 8px; border:none; cursor:pointer; font-weight:600; }

    #steps{ padding-left:14px; margin:8px 0 0 0; font-size:13px; overflow:auto; max-height:240px; color:#1b3b1b; }

    .panel-actions{ display:flex; gap:8px; margin-top:8px; }
    .panel-btn{ padding:8px 10px; font-size:13px; border-radius:8px; border:none; cursor:pointer; flex:1; display:inline-flex; align-items:center; justify-content:center; gap:8px; }
    #resetDirections{ background:#ef5350; color:white; }
    #toggleAudio{ background:#1976d2; color:white; }
    #guideToggleBtn{ background:#43a047; color:white; }
    #clearTarget{ background:#9e9e9e; color:white; }

    .target-info{ font-size:13px; color:#444; margin-top:6px; }

    /* Gallery panel (shrunk + slide/fade) */
    #galleryPanel{
      position:fixed; left:0; right:0; bottom:-200%; height:var(--gallery-h-desktop); background:rgba(255,255,255,0.98); border-top:3px solid #2e7d32;
      z-index:1500; padding:14px 20px; box-sizing:border-box; display:flex; align-items:center; justify-content:center; transition: bottom 360ms cubic-bezier(.2,.9,.3,1), opacity 320ms ease;
      overflow:visible; opacity:0;
    }
    #galleryPanel.active{ bottom:0; opacity:1; }

    .gallery-title{ position:absolute; top:8px; left:50%; transform:translateX(-50%); background:#fff; color:#2e7d32; padding:6px 10px; border-radius:10px; font-size:13px; z-index:1510; box-shadow:0 6px 18px rgba(0,0,0,0.08); }

    .carousel-viewport{ width:100%; max-width:1100px; overflow:visible; }
    .carousel-track{ display:flex; gap:14px; align-items:center; justify-content:center; will-change:transform; }
    .carousel-card{ width:240px; height:150px; flex:0 0 240px; border-radius:10px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.12); position:relative; transition: transform 0.45s cubic-bezier(.2,.9,.3,1), opacity 0.36s ease; cursor:pointer; background:#fff; }
    .carousel-card img{ width:100%; height:100%; object-fit:cover; display:block; }
    .carousel-card .label{ position:absolute; left:8px; bottom:8px; background:rgba(0,0,0,0.55); color:white; padding:6px 10px; border-radius:6px; font-size:13px; }
    .carousel-card.side{ transform: scale(0.94); opacity:0.5; }
    .carousel-card.center{ transform: scale(1.04); opacity:1; }
    .carousel-card.anim-center-out{ transform: translateX(-24px) scale(1); opacity:0.5; }
    .carousel-card.anim-side-zoom{ transform: scale(1.03); opacity:0.95; }

    .carousel-nav{ position:absolute; top:50%; transform:translateY(-50%); width:56px; height:56px; border-radius:50%; border:none; background:rgba(255,255,255,0.95); color:#2e7d32; font-size:24px; cursor:pointer; box-shadow:0 8px 22px rgba(0,0,0,0.12); z-index:1600; }
    #galleryPrev{ left:18px; }
    #galleryNext{ right:18px; }

    /* Modal */
    #infoModal{ display:none; opacity:0; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.88); z-index:3000; align-items:center; justify-content:center; transition:opacity 0.28s ease; }
    #infoModal.show{ display:flex; opacity:1; }
    .modal-inner{ position:relative; width:92%; max-width:1000px; text-align:center; padding:18px; }
    #modalWrapper{ position:relative; display:flex; align-items:center; justify-content:center; min-height:320px; }
    #modalImg{ max-width:92%; max-height:68vh; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.45); transition: transform 0.42s cubic-bezier(.2,.9,.3,1), opacity 0.36s ease; }
    #modalTitle{ color:white; font-size:1.25rem; margin-bottom:10px; text-align:center; }
    #modalInfo{ color:#ddd; margin-top:12px; max-width:90%; text-align:center; font-size:15px; }

    .tts-controls{ margin-top:12px; display:flex; gap:12px; justify-content:center; align-items:center; color:#ddd; }
    .tts-controls button{ background:#fff; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.06); font-size:14px; }
    .tts-controls input[type="range"]{ width:140px; }

    .side-btn{ position:fixed; top:50%; transform:translateY(-50%); width:64px; height:64px; border-radius:50%; background:rgba(173,255,176,0.12); color:white; border:none; font-size:28px; cursor:pointer; z-index:3500; }
    .side-btn.left{ left:14px; }
    .side-btn.right{ right:14px; }
    #closeModal{ position:fixed; top:14px; right:14px; width:64px; height:64px; border-radius:50%; background:rgba(173,255,176,0.12); color:white; border:none; font-size:28px; z-index:3600; }

    /* Popup slide + fade for marker popup wrapper */
    .leaflet-popup-content-wrapper {
      transform: translateY(8px);
      opacity: 0;
      transition: transform 220ms ease, opacity 220ms ease;
    }
    .leaflet-popup-content-wrapper.pop-float {
      transform: translateY(0px);
      opacity: 1;
    }

    /* Responsive */
    @media (max-width:920px){ :root{ --panel-w:280px; } .carousel-card{ width:210px; height:130px; } #galleryFab{ width:120px; height:76px; } }
    @media (max-width:600px){
      :root{ --panel-w:240px; }
      #galleryPanel{ height:var(--gallery-h-mobile); }
      #guide-panel{ width:var(--panel-w); max-height:50vh; }
      #galleryFab{ left:12px; bottom:12px; width:110px; height:72px; }
      #keyFab{ left:12px; bottom:100px; width:50px; height:50px; }
      #guideFab{ right:12px; width:50px; height:50px; }
      .carousel-card{ width:170px; height:110px; }
      .tts-controls input[type="range"]{ width:110px; }
    }

    /* Toast */
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:22px; background:rgba(0,0,0,0.75); color:white; padding:8px 12px; border-radius:10px; display:none; z-index:4000; font-size:13px; }
    #toast.show{ display:block; opacity:1; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- FABs -->
  <div id="galleryFab" title="Gallery preview">
    <img id="fabImg0" src="" alt="">
    <img id="fabImg1" src="" alt="">
    <div class="caption">Key areas</div>
  </div>
  <button id="galleryMiniClose" title="Close gallery">â–²</button>
  <div id="keyFab" title="Key people">ðŸ‘¤</div>
  <div id="guideFab" title="Directions">ðŸ§­</div>

  <!-- Guide Panel -->
  <div id="guide-panel" aria-hidden="true">
    <div id="guide-header">
      <h4>DIRECTIONS</h4>
      <button id="panelClose" title="Close">âœ•</button>
    </div>

    <div id="targetStatus" class="target-info" style="display:none;">Target: <span id="targetName"></span></div>
    <ol id="steps" style="margin:8px 0 0 0; padding-left:14px;"></ol>

    <div class="panel-actions" style="margin-top:10px;">
      <button id="resetDirections" class="panel-btn">ðŸ”„ Reset</button>
      <button id="toggleAudio" class="panel-btn">ðŸ”‡ Audio: Off</button>
    </div>
    <div style="height:8px"></div>
    <div class="panel-actions">
      <button id="guideToggleBtn" class="panel-btn">â–¶ Start Proximity Guide</button>
      <button id="clearTarget" class="panel-btn">ðŸ§­ Clear Target</button>
    </div>

    <div style="font-size:12px; color:#666; margin-top:10px;">
      Tip: click markers to pick start/end for directions. Double-click a marker to set it as the proximity <strong>target</strong>.
    </div>
  </div>

  <!-- Gallery Panel -->
  <div id="galleryPanel">
    <div class="gallery-title">Key Information</div>
    <button class="carousel-nav" id="galleryPrev">â—€</button>
    <div class="carousel-viewport">
      <div id="carouselViewport" class="carousel-track"></div>
    </div>
    <button class="carousel-nav" id="galleryNext">â–¶</button>
  </div>

  <!-- Modal -->
  <div id="infoModal" aria-hidden="true">
    <div class="modal-inner">
      <div id="modalTitle"></div>
      <div id="modalWrapper"><img id="modalImg" src="" alt=""></div>
      <div id="modalInfo"></div>

      <div class="tts-controls" id="ttsControls">
        <button id="ttsToggle" title="Play / Pause"><i class="fa-solid fa-play"></i></button>
        <div class="tts-rate">
          <label for="ttsRate" style="color:#ddd; font-size:14px;">Speed</label>
          <input id="ttsRate" type="range" min="0.6" max="1.8" step="0.1" value="1">
        </div>
      </div>
    </div>

    <button id="modalPrev" class="side-btn left">â—€</button>
    <button id="modalNext" class="side-btn right">â–¶</button>
    <button id="closeModal" class="side-btn close">âœ•</button>
  </div>

  <div id="toast"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ===== Map setup =====
    const centerCoords = [14.4095, 121.0198];
    const map = L.map('map', { dragging:true, zoomControl:false, scrollWheelZoom:true }).setView(centerCoords, 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const zoomControl = L.control.zoom({ position: 'bottomright' }).addTo(map);

    // user marker
    const userIcon = L.divIcon({ html:'ðŸš¶â€â™‚ï¸', className:'', iconSize:[24,24], iconAnchor:[12,12] });
    const userMarker = L.marker([0,0], { icon:userIcon }).addTo(map);
map.on('locationfound', e => {
  userMarker.setLatLng(e.latlng);
  checkProximity({ coords: { latitude: e.latitude, longitude: e.longitude } });
});

     // ===== data =====
    const buildings = [
      { name: "Sports Pavilion", coords:[14.4102708, 121.0194265], info: "Modern sports venue used for school function and physical education activities." },
      { name: "Julius K. Quiambao Football Field", coords:[14.4104647, 121.0201077], info: "A FIFA-certified turf field" },
      { name: "St. Mutien Marie Administration Building", coords:[14.4097899, 121.0204980], info: "Administration and Registrar offices" },
      { name: "St. La Salle Building", coords:[14.4093200, 121.0201930], info: "Classrooms and offices" },
      { name: "Cadlum Hall & St. Leo Flavius Hall", coords:[14.4096818, 121.0193090], info: "Halls for cafeteria and stalls" },
      { name: "Angelo King Center for Performing Arts", coords:[14.4096396, 121.0196036], info: "The CPA houses the Sylvia P. Lina Theater." },
      { name: "Br. Ceci Hojilla FSC", coords:[14.4087662, 121.0209836], info: "Center for Lasallian Formation"},
      { name: "Our Lady of the Star Chapel", coords:[14.4086150, 121.0206765], info: "The chapel serves as the main spiritual hub for the school community." },
      { name: "St. Joseph Building", coords:[14.410289252625368, 121.01894337355556], info: "STEM and IT facilities."},
      { name: "Taekwondo Gym 3", coords:[14.410508, 121.018902], info: "A multi-use gym" },
      { name: "School Fountain", coords:[14.409468, 121.019594], info: "The central campus landmark." },
      { name: "Debbie Decena Auditorium", coords:[14.409014, 121.020375], info: "Auditorium for events and gatherings." }
    ];

/* === Galleries (fixed names + direct links) === */
const buildingGalleries = {
  "School Fountain": [
    {
      src: "https://i.ibb.co/7hRwrFs/IMG-20250812-145646.jpg",
      desc: "The iconic fountain at the heart of campus, often used as a landmark and meeting place."
    },
    {
      src: "https://i.ibb.co/4RvKCLMX/IMG-20250812-145633.jpg",
      desc: "Another view of the school fountain, showing the surrounding greenery and open space."
    }
  ],

  "Sports Pavilion": [
    {
      src: "https://i.ibb.co/23JN8tq1/pav-exterior.jpg",
      desc: "Under the leadership of Bro. Dennis Magbanua FSC, where the school undertook a major transformation year 2007-2009. It reopened as the modern Sports Pavilion, blending the old structure with a bold new dome addition."
    },
    {
      src: "https://i.ibb.co/KjJqPLPR/SAM-1009.jpg",
      desc: "Used extensively for PE classes, varsity training, and facilities for various sports: basketball, volleyball, futsal, table tennis, judo, dance, and chess."
    },
    {
      src: "https://i.ibb.co/ycMVDD3m/pav-interior.jpg",
      desc: "The Pavilion reflects Lasallian pride, fostering sportsmanship and excellence among students. It also accommodates the entire grade school and high school populations during large gatherings."
    }
  ],

  "Angelo King Center for Performing Arts": [
    {
      src: "https://i.ibb.co/TDzP6dVs/IMG-20250812-145543.jpg",
      desc: "The Angelo King Center for Performing Arts at De La Salle Santiago Zobel (DLSZ) was constructed between 1996 and 2000 through the generous support of philanthropist Mr. Angelo King"
    },
    {
      src: "https://i.ibb.co/XfTtMv2N/6451256-orig.jpg",
      desc: "In 2004, the Cultural Center of the Philippines (CCP) officially recognized the CPA as its Southern Satellite Venue, giving it the nickname â€œCCP of the Southâ€. The CPA continues to play a central role in arts education, cultural formation, and community performances, making it a true icon in the Lasallian educational mission."
    }
  ],

  "Cadlum Hall & St. Leo Flavius Hall": [
    {
      src: "https://i.ibb.co/7JKWkRGK/IMG-20250812-145529.jpg",
      desc: "Named after St. Leo the Great (Leo Flavius), a Doctor of the Church known for his wisdom, leadership, and theological contributions"
    },
    {
      src: "https://i.ibb.co/Kxp9Y2s5/IMG-20250812-145411.jpg",
      desc: "It is the place that are commemorated for the Lasallian martyrs who were massacred in World War 2 at DLSU on Taft Most Blessed Sacrament Chapel."
    }
  ],

  "Julius K. Quiambao Foodball Field": [
    {
      src: "https://i.ibb.co/bj2smjwQ/IMG-20250812-144752.jpg",
      desc: "The facility is renamed Julius Caesar Kindangen Quiambao Football Field in honor of Quiambaoâ€™s legacy."
    },
    {
      src: "https://i.ibb.co/8g42CmZ9/IMG-20250812-144741.jpg",
      desc: "Last October 2024, the field becomes the first FIFA Quality Certified pitch at a privately-run Kâ€“12 school in the Philippines. Upgrades included premium Limonta Duo Shape 50 mm artificial turf, enhanced drainage, leveled base, and long-term maintenance through E-Sports Intl. Inc."
    },
    {
      src: "https://i.ibb.co/67xPD9LN/IMG-20250812-144616.jpg",
      desc: "Serves as the main training and match venue for DLSZ's football teams (Junior/Senior Archers and Lady Junior Archers), intramurals, and other sports like ultimate frisbee."
    },
    {
      src: "https://i.ibb.co/fdVvqTJ7/IMG-20250812-144553.jpg",
      desc: "It also occasionally hosts tournaments open to external teams and even national squads."
    }
  ],

  "St. Joseph Building": [
    {
      src: "https://i.ibb.co/bjd1yzCn/IMG-20250812-145219.jpg",
      desc: "It was named to honor Saint Joseph, a patron of families and workers. This naming reflects the Lasallian educational philosophy, which emphasizes community, service, and faith as essential pillars of student formation."
    },
    {
      src: "https://i.ibb.co/DHzMmCxx/IMG-20250812-145151.jpg",
      desc: "It was constructed in the late 1980s, during a pivotal period of growth for De La Salle Santiago Zobel School (DLSZ). As one of the earliest permanent structures of DLSZ, it played a foundational role in establishing the schoolâ€™s physical identity and its commitment to nurturing young learners in a safe and values-centered environment."
    }
  ],

  "St. Mutien Marie Building": [
    {
      src: "https://i.ibb.co/99wq1943/IMG-20250812-144302.jpg",
      desc: "The building honors St. Mutien Marie Wiaux, a Belgian De La Salle Brother, who was canonized in 1989. Brother Mutien Marie was known for his humble services, discipline, and devotion to teaching students in the arts and religious formation."
    },
    {
      src: "https://i.ibb.co/JwhM0scK/IMG-20250812-144457.jpg",
      desc: "This building serves as the central hub for the campus's administrative operations."
    }
  ],

"St. La Salle Building": [
{
src: "https://i.ibb.co/XH7D6N3/image.png",
desc: "The St. La Salle Building is named after St. John Baptist de La Salle, born on April 30, 1651, the visionary founder of the Institute of the Brothers of the Christian Schools and the recognized Patron Saint of Educators. His legacy in education, particularly his dedication to forming Christian communities through teaching, is deeply reflected in the buildingâ€™s name and purpose."
},
  {
src: "https://i.ibb.co/HLMJz9Gt/IMG-3405.jpg",
desc: "Moreover, it is established to have a more conducive and suitable learning environment, an extension of De La Salle University, the first De La Salle School in the Philippines found in Paco, Manila."
},
{
src: "https://i.ibb.co/qYWD0fdb/IMG-3396.jpg",
desc: "Year 1976, it is the first building that was established to accommodate both elementary and high school classrooms at the campus, it was constructed during the institutionâ€™s formative years. Additionally, before the family of Jacobo Santiago Zobel donated the lot at Ayala Alabang, the original name of DLSZ was De La Salle-South School. It is changed in gratitude to Enrique Zobelâ€™s generosity, after his son died at the young age of 11."
}
],

  "Br. Ceci Hojilla FSC Center for Lasallian Formation": [
    {
      src: "https://i.ibb.co/4ZPJCbGp/IMG-20250812-143911.jpg",
      desc: "The Br. Ceci Hojilla FSC Center for Lasallian Formation (CLF), named after the brother who dedicated his life to guiding the youth, was established as a sacred space for deepening the Lasallian identity and strengthening spiritual growth at De La Salle Santiago Zobel (DLSZ). It embodies the schoolâ€™s mission to raise Christian Achievers for God and Country through values rooted in Faith, Service, and Communion in Mission."
    },
    {
      src: "https://i.ibb.co/jvzr9cKS/IMG-20250812-143953.jpg",
      desc: "CLF was created as a dedicated venue to form students in the Lasallian tradition, centered on the 5Cs: Christian, Committed, Competent, Compassionate, and Confident. All these values are lived out through various Lasallian Formation activities hosted within this facility."
    }
  ],

  "Debbie Decena Auditorium": [
    {
      src: "https://i.ibb.co/1J8TtmrG/IMG-20250812-143555.jpg",
      desc: "This auditorium is dedicated to honor the memory of Deborah \"Debbie\" Decena, Gr. 4 - B student, who died in an accident within the school grounds on 20 November 1998 during the School's 18th Founding Week observance. Presented to the Decena Family on 14 June 2000."
    },
    {
      src: "https://i.ibb.co/GLJ5HnF/IMG-20250812-143610.jpg",
      desc: "Her contributions helped realize the vision of a dedicated space for performing arts, assemblies, and institutional gatherings."
    },
    {
      src: "https://i.ibb.co/cc5zXjmV/IMG-20250812-143627.jpg",
      desc: "Serves as the main auditorium of the DLSZ Alabang campus."
    }
  ],

  "Our Lady of the Star Chapel": [
    {
      src: "https://i.ibb.co/J1BTFp0/OLS-Chapel.jpg",
      desc: "The OLStar Chapel, located on the second floor of the Br. Ceci Hojilla FSC Center for Lasallian Formation (CLF), was purpose-built to provide students and staff with a faith, service, and communion within the school community."
    }
  ]
};
    const keyPeopleGallery = [ { name:"Brother Rafael Donato FSC", src:"https://i.ibb.co/v46N36LY/br-rafe-donato.jpg", desc:"On the year 1997, the school that's was established for underprivileged adults that is originally named as Adult Night High School. Later on, it expanded to include the younger generation which is now known as the Br. Rafael Donato FSC Night High School. In commemoration, each year, the school remembers Br. Rafe every 2nd of November after his death and celebrate his birthday every 12th of October." } ];


    // ===== routing graph & helpers =====
    const nodeMap = {}, adjacencyList = {};
    buildings.forEach(b => { nodeMap[b.name] = b.coords; adjacencyList[b.name] = []; });
    function addEdge(a,b){ if(!nodeMap[a]||!nodeMap[b]) return; const [la,lo]=nodeMap[a], [lb,lo2]=nodeMap[b]; const dist=Math.hypot(la-lb, lo-lo2); adjacencyList[a].push({node:b,dist}); adjacencyList[b].push({node:a,dist}); }
    addEdge("Sports Pavilion","Taekwondo Gym 3");
    addEdge("Taekwondo Gym 3","St. Joseph Building");
    addEdge("Sports Pavilion","Angelo King Center for Performing Arts");
    addEdge("Angelo King Center for Performing Arts","Cadlum Hall & St. Leo Flavius Hall");
    addEdge("Cadlum Hall & St. Leo Flavius Hall","School Fountain");
    addEdge("School Fountain","St. La Salle Building");
    addEdge("St. La Salle Building","St. Mutien Marie Administration Building");
    addEdge("St. Mutien Marie Administration Building","Br. Ceci Hojilla FSC");
    addEdge("Br. Ceci Hojilla FSC","Our Lady of the Star Chapel");
    addEdge("St. La Salle Building","Julius K. Quiambao Football Field");
    addEdge("Debbie Decena Auditorium","St. Mutien Marie Administration Building");
    addEdge("Debbie Decena Auditorium","St. La Salle Building");

    function dijkstra(s,e){
      const dist={}, prev={};
      Object.keys(adjacencyList).forEach(n=>{dist[n]=1e9; prev[n]=null;});
      dist[s]=0;
      const Q=Object.keys(dist).slice();
      while(Q.length){
        Q.sort((a,b)=>dist[a]-dist[b]);
        const u=Q.shift();
        if(u===e) break;
        adjacencyList[u].forEach(({node:vn, dist:d2})=>{
          if(dist[u]+d2<dist[vn]){ dist[vn]=dist[u]+d2; prev[vn]=u; }
        });
      }
      const path=[]; let u=e;
      while(u){ path.unshift(u); u=prev[u]; }
      return path;
    }

    function getDirection(prevC, current, next){
      const angle=(p1,p2)=>Math.atan2(p2[1]-p1[1], p2[0]-p1[0]);
      const deg=x=>x*(180/Math.PI);
      const a1=angle(prevC,current), a2=angle(current,next);
      let delta=deg(a2-a1); delta=((delta+360)%360);
      if(delta<30||delta>330) return "Go straight";
      if(delta>=30&&delta<=150) return "Turn right";
      if(delta>=210&&delta<=330) return "Turn left";
      return "Continue";
    }

    // route layer and computeRoute -> populates steps
let routeLayer = null;
let currentRoute = null;
let currentStepIndex = 0;

function computeRoute(a, b) {
  const p = dijkstra(a, b);
  if (!p || p.length === 0) return;
  if (routeLayer) map.removeLayer(routeLayer);

  const coords = p.map(n => nodeMap[n]);
  currentRoute = coords;
  currentStepIndex = 0;

  routeLayer = L.polyline(coords, { color: '#90ee90', weight: 5, dashArray: '5,5' }).addTo(map);
  map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });

  // fill steps in panel
  const stepsEl = document.getElementById('steps');
  stepsEl.innerHTML = '';
  for (let i = 0; i < p.length; i++) {
    if (i === 0) stepsEl.innerHTML += `<li>Start at ${p[i]}</li>`;
    else if (i === p.length - 1) stepsEl.innerHTML += `<li>Arrive at ${p[i]}</li>`;
    else {
      const dir = getDirection(nodeMap[p[i - 1]], nodeMap[p[i]], nodeMap[p[i + 1]]);
      stepsEl.innerHTML += `<li>${dir} to ${p[i + 1]}</li>`;
    }
  }

  // open panel & reposition
  document.getElementById('guide-panel').classList.add('active');
  setTimeout(positionControls, 90);
}
    // ===== markers & interactions =====
    let start=null, end=null;
    let markers = {};
    buildings.forEach(b=>{
      const marker = L.marker(b.coords).addTo(map);
      markers[b.name] = marker;
     marker.bindPopup(`<b>${b.name}</b><br>${b.info || ''}`);

      let locked=false;
      marker.on('mouseover', ()=>{ if(!locked) marker.openPopup(); setTimeout(()=>{ const cw = document.querySelector('.leaflet-popup-content-wrapper'); if(cw) cw.classList.add('pop-float'); }, 10); });
      marker.on('mouseout', ()=>{ if(!locked) marker.closePopup(); });
      marker.on('popupclose', ()=>{ locked=false; const cw = document.querySelector('.leaflet-popup-content-wrapper'); if(cw) cw.classList.remove('pop-float'); });

      marker.on('click', ()=>{
        locked = true;
        marker.openPopup();
        if(!start){ start = b.name; showToast(`Start selected: ${start}`); }
        else if(!end){ end = b.name; if(start === end){ start = end = null; showToast('Selection cleared (same place)'); return; } computeRoute(start, end); start = end = null; }
      });

      marker.on('dblclick', ()=>{
        setTarget(b.name);
        showToast(`Target set: ${b.name}`);
        marker.openPopup();
      });
    });

    // ===== modal logic (improved slide + fade) =====
    const modal = document.getElementById('infoModal');
    const modalImg = document.getElementById('modalImg');
    const modalTitle = document.getElementById('modalTitle');
    const modalInfo = document.getElementById('modalInfo');

    let currentGallery = [], galleryIndex = 0, activeBuildingName = '';

    function showModalFromCurrent(){
      if(!currentGallery || !currentGallery.length) return;
      resetModalTTS();
      modal.style.display = 'flex';
      requestAnimationFrame(()=> modal.classList.add('show') );
      setTimeout(()=>{
        modalImg.src = currentGallery[galleryIndex].src;
        modalTitle.textContent = activeBuildingName || '';
        modalInfo.textContent = currentGallery[galleryIndex].desc || '';
      }, 60);
    }

    function openInfoModal(name, index){
      const gallery = buildingGalleries[name];
      if(gallery && gallery.length){ currentGallery = gallery.slice(); }
      if(!currentGallery || !currentGallery.length) return;
      galleryIndex = (typeof index === 'number')? Math.max(0, Math.min(index, currentGallery.length-1)) : 0;
      activeBuildingName = name || activeBuildingName || '';
      showModalFromCurrent();
    }

    function closeModal(){
      resetModalTTS();
      modal.classList.remove('show');
      setTimeout(()=>{ modal.style.display = 'none'; }, 280);
    }

    function updateModalImage(direction){
      if(!currentGallery.length) return;
      resetModalTTS();
      const next = currentGallery[galleryIndex];
      modalTitle.textContent = activeBuildingName || '';
      modalInfo.textContent = next.desc || '';

      const wrapper = document.getElementById('modalWrapper');
      wrapper.style.position = 'relative';

      const incoming = document.createElement('img');
      incoming.src = next.src;
      incoming.style.position = 'absolute';
      incoming.style.left = '50%';
      incoming.style.top = '50%';
      const startX = (direction === 'prev') ? '-120%' : '120%';
      incoming.style.transform = `translate(-50%,-50%) translateX(${startX})`;
      incoming.style.maxWidth = '92%'; incoming.style.maxHeight = '68vh';
      incoming.style.borderRadius = '12px';
      incoming.style.transition = 'transform 0.38s cubic-bezier(.2,.9,.3,1), opacity 0.32s ease';
      incoming.style.opacity = '0';
      wrapper.appendChild(incoming);

      requestAnimationFrame(() => {
        const exitX = (direction === 'prev') ? '120%' : '-120%';
        modalImg.style.transform = `translateX(${exitX})`;
        modalImg.style.opacity = '0';
        incoming.style.transform = 'translate(-50%,-50%) translateX(0)';
        incoming.style.opacity = '1';
      });

      const onTransitionEnd = (e) => {
        if (e.target !== incoming) return;
        incoming.removeEventListener('transitionend', onTransitionEnd);
        modalImg.style.transition = 'none';
        modalImg.src = next.src;
        modalImg.style.transform = 'none';
        modalImg.style.opacity = '1';
        void modalImg.offsetWidth;
        modalImg.style.transition = '';
        if (incoming.parentNode) incoming.parentNode.removeChild(incoming);
      };
      incoming.addEventListener('transitionend', onTransitionEnd);
    }

    document.getElementById('modalNext').addEventListener('click', ()=>{
      if(!currentGallery.length) return;
      galleryIndex = (galleryIndex + 1) % currentGallery.length;
      updateModalImage('next');
    });
    document.getElementById('modalPrev').addEventListener('click', ()=>{
      if(!currentGallery.length) return;
      galleryIndex = (galleryIndex - 1 + currentGallery.length) % currentGallery.length;
      updateModalImage('prev');
    });

    document.getElementById('closeModal').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

let modalTouchStartX = 0;
let modalIsDragging = false;

const modalWrapper = document.getElementById('modalWrapper');

modalWrapper.addEventListener('touchstart', e => {
  modalTouchStartX = e.touches[0].clientX;
  modalIsDragging = true;
});

modalWrapper.addEventListener('touchmove', e => {
  // optional: add visual feedback if desired
});

modalWrapper.addEventListener('touchend', e => {
  if (!modalIsDragging) return;
  modalIsDragging = false;
  const deltaX = e.changedTouches[0].clientX - modalTouchStartX;

  if (deltaX > 50) {
    // Swipe right â†’ previous image
    galleryIndex = (galleryIndex - 1 + currentGallery.length) % currentGallery.length;
    updateModalImage('prev');
  } else if (deltaX < -50) {
    // Swipe left â†’ next image
    galleryIndex = (galleryIndex + 1) % currentGallery.length;
    updateModalImage('next');
  }
});

    // ===== Carousel (animated) =====
    const places = Object.keys(buildingGalleries);
    let placeIndex = 0;
    const viewportEl = document.getElementById('carouselViewport');
    let isAnimating = false;
    const animDuration = 440;

    function makeCard(i, cls) {
      const card = document.createElement('div');
      card.className = `carousel-card ${cls}`;
      const img = document.createElement('img');
      img.src = buildingGalleries[places[i]][0].src;
      img.alt = places[i];
      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = places[i];
      card.appendChild(img);
      card.appendChild(label);

      if (cls === 'center') {
        card.onclick = () => {
          card.style.transform = (card.style.transform || '') + ' scale(1.06)';
          setTimeout(() => {
            card.style.transform = '';
            openInfoModal(places[i], 0);
          }, 120);
        };
      } else {
        card.onclick = () => {
          const nextIdx = (placeIndex + 1) % places.length;
          animateCarousel(i === nextIdx ? 'next' : 'prev');
        };
      }
      return card;
    }

    function renderCarousel(updateOnly = false) {
      if (!places.length) return;
      const prevIdx = (placeIndex - 1 + places.length) % places.length;
      const nextIdx = (placeIndex + 1) % places.length;

      if (updateOnly && viewportEl.children.length === 3) {
        const prevCard = viewportEl.children[0];
        const centerCard = viewportEl.children[1];
        const nextCard = viewportEl.children[2];

        prevCard.className = "carousel-card side";
        prevCard.querySelector("img").src = buildingGalleries[places[prevIdx]][0].src;
        prevCard.querySelector(".label").textContent = places[prevIdx];
        prevCard.onclick = () => animateCarousel('prev');

        centerCard.className = "carousel-card center";
        centerCard.querySelector("img").src = buildingGalleries[places[placeIndex]][0].src;
        centerCard.querySelector(".label").textContent = places[placeIndex];
        centerCard.onclick = () => {
          centerCard.style.transform = (centerCard.style.transform || '') + ' scale(1.06)';
          setTimeout(() => { centerCard.style.transform = ''; openInfoModal(places[placeIndex], 0); }, 120);
        };

        nextCard.className = "carousel-card side";
        nextCard.querySelector("img").src = buildingGalleries[places[nextIdx]][0].src;
        nextCard.querySelector(".label").textContent = places[nextIdx];
        nextCard.onclick = () => animateCarousel('next');

        return;
      }

      viewportEl.innerHTML = '';
      viewportEl.appendChild(makeCard(prevIdx, 'side'));
      viewportEl.appendChild(makeCard(placeIndex, 'center'));
      viewportEl.appendChild(makeCard(nextIdx, 'side'));
    }

    function animateCarousel(dir) {
      if (isAnimating) return;
      if (!places.length) return;
      isAnimating = true;
      if (viewportEl.children.length !== 3) { renderCarousel(); }

      const prevEl = viewportEl.children[0];
      const centerEl = viewportEl.children[1];
      const nextEl = viewportEl.children[2];

      const newIndex = (dir === 'next') ? (placeIndex + 1) % places.length : (placeIndex - 1 + places.length) % places.length;

      centerEl.classList.add('anim-center-out');
      prevEl.classList.add('anim-side-zoom');
      nextEl.classList.add('anim-side-zoom');

      setTimeout(() => {
        centerEl.classList.remove('anim-center-out');
        prevEl.classList.remove('anim-side-zoom');
        nextEl.classList.remove('anim-side-zoom');

        placeIndex = newIndex;
        renderCarousel(true);
        setTimeout(()=>{ isAnimating = false; }, 40);
      }, animDuration);
    }

    document.getElementById('galleryPrev').addEventListener('click', ()=>animateCarousel('prev'));
    document.getElementById('galleryNext').addEventListener('click', ()=>animateCarousel('next'));

    // touch swipe
    let touchStartX = 0;
    viewportEl.addEventListener('touchstart', (e)=>{ touchStartX = e.touches[0].clientX; });
    viewportEl.addEventListener('touchend', (e)=>{ const dx = e.changedTouches[0].clientX - touchStartX; if(dx < -40) animateCarousel('next'); else if(dx > 40) animateCarousel('prev'); });

    // ===== Gallery FAB preview & open/close =====
    (function setupGalleryFab(){
      const fab = document.getElementById('galleryFab');
      const imgEls = [document.getElementById('fabImg0'), document.getElementById('fabImg1')];
      const keys = Object.keys(buildingGalleries);
      const preview = [];
      for(let i=0;i<Math.min(8, keys.length); i++){ const g = buildingGalleries[keys[i]]; if(g && g[0]) preview.push(g[0].src); }
      if(preview.length === 0){ imgEls[0].style.opacity=0; }
      else{
        imgEls.forEach((el,i)=>{ el.src = preview[i % preview.length]; if(i===0) el.classList.add('active'); });
        let idx=0;
        setInterval(()=>{
          imgEls[idx%2].classList.remove('active');
          idx = (idx+1) % preview.length;
          imgEls[(idx)%2].src = preview[idx];
          imgEls[(idx)%2].classList.add('active');
        }, 2600);
      }

      const miniClose = document.getElementById('galleryMiniClose');
      const panel = document.getElementById('galleryPanel');

      fab.addEventListener('click', ()=>{
        if(panel.classList.contains('active')){
          panel.classList.remove('active');
          miniClose.classList.remove('show');
          showToast('Gallery closed');
        } else {
          renderCarousel();
          panel.classList.add('active');
          miniClose.classList.add('show');
          showToast('Gallery opened');
        }
        setTimeout(positionControls, 110);
      });

      miniClose.addEventListener('click', ()=>{
        if(!panel.classList.contains('active')) return;
        panel.classList.remove('active');
        miniClose.classList.remove('show');
        showToast('Gallery closed');
        setTimeout(positionControls, 110);
      });
    })();

    // key people FAB
    document.getElementById('keyFab').addEventListener('click', ()=>{
      const p = keyPeopleGallery[0];
      if(!p){ showToast('No key people'); return; }
      currentGallery = [{ src: p.src, desc: p.desc }]; galleryIndex = 0; activeBuildingName = p.name; showModalFromCurrent();
    });

    // ===== Guide UI & logic (side panel) =====
    const guideFabEl = document.getElementById('guideFab');
    const guidePanelEl = document.getElementById('guide-panel');
    const panelCloseBtn = document.getElementById('panelClose');
    const resetBtn = document.getElementById('resetDirections');
    const toggleAudioBtn = document.getElementById('toggleAudio');
    const guideToggleBtn = document.getElementById('guideToggleBtn');
    const targetStatus = document.getElementById('targetStatus');
    const targetNameEl = document.getElementById('targetName');
    const clearTargetBtn = document.getElementById('clearTarget');

    let audioEnabled = false;
    let guideActive = false;
    let watchId = null;
    const triggerRadius = 30;
    let spokenBuildings = new Set();
    let targetedBuilding = null;
    let lastTargetState = 'far';

    guideFabEl.addEventListener('click', ()=>{
      guidePanelEl.classList.toggle('active');
      setTimeout(positionControls, 110);
    });
    panelCloseBtn.addEventListener('click', ()=>{
      guidePanelEl.classList.remove('active');
      setTimeout(positionControls, 110);
    });

 resetBtn.addEventListener('click', ()=>{
  if(routeLayer){ map.removeLayer(routeLayer); routeLayer = null; }
  document.getElementById('steps').innerHTML = '';
  showToast('Directions reset');
  spokenBuildings = new Set();
  currentRoute = null;
  currentStepIndex = 0;    
});

    toggleAudioBtn.addEventListener('click', ()=>{
      audioEnabled = !audioEnabled;
      toggleAudioBtn.textContent = audioEnabled ? 'ðŸ”Š Audio: On' : 'ðŸ”‡ Audio: Off';
      showToast(audioEnabled ? 'Audio enabled' : 'Audio disabled');
      if(!audioEnabled) speechSynthesis.cancel();
    });

    guideToggleBtn.addEventListener('click', ()=>{
      guideActive = !guideActive;
      guideToggleBtn.textContent = guideActive ? 'â¸ Stop Proximity Guide' : 'â–¶ Start Proximity Guide';
      if(guideActive){
        spokenBuildings = new Set();
        lastTargetState = 'far';
        startGuideMode();
        showToast('Proximity guide started');
      } else {
        stopGuideMode();
        showToast('Proximity guide stopped');
      }
    });

    clearTargetBtn.addEventListener('click', ()=>{
      if(targetedBuilding){
        targetedBuilding = null;
        targetStatus.style.display = 'none';
        targetNameEl.textContent = '';
        showToast('Target cleared');
      } else {
        showToast('No target set');
      }
    });

    function startGuideMode(){
      if ("geolocation" in navigator) {
        watchId = navigator.geolocation.watchPosition(checkProximity, (err)=>{ console.warn(err); showToast('GPS error'); }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
      } else {
        showToast('Geolocation not supported');
      }
    }
    function stopGuideMode(){
      if(watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
    }
function checkProximity(position) {
  const { latitude, longitude } = position.coords;

  if (currentRoute && currentRoute.length > 0) {
    // Route is active â†’ step-by-step guidance
    checkDirectionsProximity(latitude, longitude);
  } else if (guideActive) {
    // Campus tour mode (no route, just buildings)
    checkProximityAll(latitude, longitude);
  }

  // Always check targeted building if one is set
  if (targetedBuilding) {
    checkProximityTargeted(latitude, longitude);
  }
}
function checkProximityAll(lat, lon) {
  buildings.forEach(building => {
    const dist = getDistance(lat, lon, building.coords[0], building.coords[1]);
    if (dist <= triggerRadius && !spokenBuildings.has(building.name)) {
      const msg = `You are near ${building.name}. ${building.info}`;
      
      if (audioEnabled) speak(msg);
      showToast(msg, 2500); // âœ… toast under proximity guide
      spokenBuildings.add(building.name);
    }
  });
}

function checkDirectionsProximity(lat, lon) {
  if (!currentRoute || currentStepIndex >= currentRoute.length) return;

  const [stepLat, stepLon] = currentRoute[currentStepIndex];
  const dist = getDistance(lat, lon, stepLat, stepLon);

  if (dist <= triggerRadius) {
    let message = '';
    const building = buildings.find(b => 
      Math.abs(b.coords[0] - stepLat) < 1e-5 && 
      Math.abs(b.coords[1] - stepLon) < 1e-5
    );

    if (currentStepIndex === 0) {
      message = `Starting at ${building ? building.name : 'your starting point'}`;
    } else if (currentStepIndex === currentRoute.length - 1) {
      message = `You have arrived at your destination: ${building ? building.name : 'the target'}`;
    } else {
      const nextCoords = currentRoute[currentStepIndex + 1];
      const nextBuilding = buildings.find(b => 
        Math.abs(b.coords[0] - nextCoords[0]) < 1e-5 && 
        Math.abs(b.coords[1] - nextCoords[1]) < 1e-5
      );
      message = `Now proceed towards ${nextBuilding ? nextBuilding.name : 'the next location'}`;
    }

    if (audioEnabled) speak(message);
    currentStepIndex++;
  }
}

function checkProximityTargeted(lat, lon) {
  const b = buildings.find(x => x.name === targetedBuilding);
  if (!b) return;

  const dist = getDistance(lat, lon, b.coords[0], b.coords[1]);

  if (dist <= triggerRadius && lastTargetState !== 'near') {
    const msg = `You are now near ${b.name}. ${b.info}`;
    if (audioEnabled) speak(msg);
    showToast(msg, 2500);
    lastTargetState = 'near';
  } else if (dist > triggerRadius && lastTargetState !== 'far') {
    const msg = `You are ${Math.round(dist)} meters from ${b.name}.`;
    if (audioEnabled) speak(msg);
    showToast(msg, 2500);
    lastTargetState = 'far';
  }
}

    function getDistance(lat1, lon1, lat2, lon2){
      const R = 6371000; const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Text to speech helper (cancels previous)
    function speak(text){
      if(!('speechSynthesis' in window)) return;
      try{ speechSynthesis.cancel(); }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      speechSynthesis.speak(u);
    }

    function setTarget(name){
      targetedBuilding = name;
      targetStatus.style.display = 'block';
      targetNameEl.textContent = name;
      lastTargetState = 'far';
    }

    // toast
    function showToast(msg, time=1200){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show'); t.style.display='block';
      setTimeout(()=>{ t.style.display='none'; t.classList.remove('show'); }, time);
    }

    // keyboard nav
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowLeft'){
        if(modal.classList.contains('show')) document.getElementById('modalPrev').click();
        else if(document.getElementById('galleryPanel').classList.contains('active')) animateCarousel('prev');
      } else if(e.key === 'ArrowRight'){
        if(modal.classList.contains('show')) document.getElementById('modalNext').click();
        else if(document.getElementById('galleryPanel').classList.contains('active')) animateCarousel('next');
      }
    });

    // initial carousel render
    renderCarousel();

    // ===== Modal TTS single-button behavior =====
    let modalUtterance = null;
    let modalIsPaused = false;
    const ttsToggleBtn = document.getElementById('ttsToggle');
    const ttsRateInput = document.getElementById('ttsRate');

    function setTtsToggleIcon(isPlaying){
      const i = ttsToggleBtn.querySelector('i');
      if(!i) return;
      if(isPlaying && !modalIsPaused) i.className = 'fa-solid fa-pause';
      else i.className = 'fa-solid fa-play';
    }
    function resetModalTTS(){
      if('speechSynthesis' in window) try{ speechSynthesis.cancel(); }catch(e){}
      modalUtterance = null;
      modalIsPaused = false;
      setTtsToggleIcon(false);
    }

    ttsToggleBtn.addEventListener('click', ()=>{
      if(!('speechSynthesis' in window)){ showToast('Speech not supported'); return; }

      if(!speechSynthesis.speaking && !modalIsPaused){
        try{ speechSynthesis.cancel(); }catch(e){}
        modalUtterance = null; modalIsPaused = false;
        const textParts = [];
        if(modalTitle.textContent) textParts.push(modalTitle.textContent.trim());
        if(modalInfo.textContent) textParts.push(modalInfo.textContent.trim());
        const text = textParts.join('. ').trim();
        if(!text){ showToast('No text to read'); return; }

        modalUtterance = new SpeechSynthesisUtterance(text);
        modalUtterance.lang = "en-US";
        modalUtterance.rate = parseFloat(ttsRateInput.value || 1);
        modalUtterance.onend = () => { modalUtterance = null; modalIsPaused = false; setTtsToggleIcon(false); };
        speechSynthesis.speak(modalUtterance);
        setTtsToggleIcon(true);
        modalIsPaused = false;
      } else if(speechSynthesis.speaking && !modalIsPaused){
        try{ speechSynthesis.pause(); }catch(e){}
        modalIsPaused = true;
        setTtsToggleIcon(false);
      } else if(modalIsPaused){
        try{ speechSynthesis.resume(); }catch(e){}
        modalIsPaused = false;
        setTtsToggleIcon(true);
      } else {
        resetModalTTS();
      }
    });

    ttsRateInput.addEventListener('input', ()=>{
      if(modalUtterance) {
        try{ modalUtterance.rate = parseFloat(ttsRateInput.value); }catch(e){}
      }
    });

    // ===== POSITION CONTROLS: robust bottom-stacking (fixed) =====
    const galleryPanelEl = document.getElementById('galleryPanel');
    const guidePanelElRef = document.getElementById('guide-panel');
    const fabGalleryEl = document.getElementById('galleryFab');
    const fabKeyEl = document.getElementById('keyFab');
    const fabGuide = document.getElementById('guideFab');
    const miniCloseBtn = document.getElementById('galleryMiniClose');
    const leafletZoomEl = document.querySelector('.leaflet-control-zoom');

    function positionControls(){
      const galleryOpen = galleryPanelEl.classList.contains('active');
      const guideOpen = guidePanelElRef.classList.contains('active');
      const base = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--base-gap')) || 16;

      // gallery height
      const galleryH = galleryOpen ? Math.round(galleryPanelEl.clientHeight) : 0;

      // Stack gallery FAB + key above gallery (same logic used before)
      if (galleryOpen) {
        fabGalleryEl.style.bottom = `${galleryH + base}px`;
        miniCloseBtn.style.bottom = `${galleryH + base + 8}px`;
        const galleryFabH = fabGalleryEl.getBoundingClientRect().height || 84;
        fabKeyEl.style.bottom = `${galleryH + base + galleryFabH + 10}px`;
      } else {
        fabGalleryEl.style.bottom = `${base}px`;
        miniCloseBtn.style.bottom = `108px`;
        fabKeyEl.style.bottom = `140px`;
      }

      // When guide open, place guide panel above gallery (so both visible)
      if (guideOpen) {
        // Put guide panel bottom to be just above gallery
        guidePanelElRef.style.bottom = `${galleryH + base}px`;
        // compute guide panel height
        const guideH = Math.round(guidePanelElRef.clientHeight || 0);
        // Place guide FAB floating above the guide panel using bottom stacking (stable)
        const fabBottom = galleryH + base + guideH + 12; // 12px gap
        fabGuide.style.bottom = `${fabBottom}px`;
        fabGuide.style.top = '';
        fabGuide.style.right = '16px';
        // Leaflet zoom above the FAB (offset by ~66)
        if (leafletZoomEl){
          const zoomBottom = fabBottom + 66;
          leafletZoomEl.style.bottom = `${zoomBottom}px`;
          leafletZoomEl.style.top = '';
          leafletZoomEl.style.right = '16px';
        }
      } else {
        // guide is closed

        guidePanelElRef.style.bottom = '';

        // If gallery is open (only), move the guide FAB + zoom up above the gallery too (this is the fix you requested)
        if (galleryOpen) {
          // position guide FAB similar elevation to left-side FABs (but on right side)
          const guideFabBottom = galleryH + base; // same baseline as gallery FAB
          fabGuide.style.bottom = `${guideFabBottom}px`;
          fabGuide.style.top = '';
          fabGuide.style.right = '16px';
          // put zoom controls above the guide FAB
          if (leafletZoomEl){
            const zoomBottom = guideFabBottom + 66;
            leafletZoomEl.style.bottom = `${zoomBottom}px`;
            leafletZoomEl.style.top = '';
            leafletZoomEl.style.right = '16px';
          }
        } else {
          // neither guide nor gallery open: reset to defaults
          fabGuide.style.top = '';
          fabGuide.style.bottom = `${base}px`;
          fabGuide.style.right = `16px`;
          if (leafletZoomEl){
            leafletZoomEl.style.top = '';
            leafletZoomEl.style.bottom = `86px`;
            leafletZoomEl.style.right = `16px`;
          }
        }
      }
    }

    // recalc layout on resize and toggles
    window.addEventListener('resize', ()=> setTimeout(positionControls, 90));
    ['galleryFab','galleryMiniClose','keyFab','guideFab','panelClose','galleryPrev','galleryNext'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.addEventListener('click', ()=> setTimeout(positionControls, 120));
    });

    // initial run
    setTimeout(positionControls, 320);

    // cancel tts helper
    function cancelAllTTS(){ if('speechSynthesis' in window) try{ speechSynthesis.cancel(); }catch(e){} }
    document.getElementById('galleryFab').addEventListener('click', ()=>cancelAllTTS());
    document.getElementById('panelClose').addEventListener('click', ()=>cancelAllTTS());
    document.getElementById('closeModal').addEventListener('click', ()=>cancelAllTTS());
  </script>
</body>
</html>
